spec:
  template:
    spec:
      volumes:
        - name: var-files
          emptyDir: {}
        - name: plugins-dir
          emptyDir: {}
        - name: custom-tools
          emptyDir: {}
        - name: sops-age
          secret:
            secretName: sops-age-key
        - name: cmp-plugin
          configMap:
            name: cmp-plugin
      initContainers:
        - name: install-tools
          image: alpine:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              apk add --no-cache ca-certificates wget tar sed
              wget -O /custom-tools/sops https://github.com/getsops/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64
              chmod +x /custom-tools/sops
              wget -O /tmp/helm-secrets.tar.gz https://github.com/jkroepke/helm-secrets/releases/download/v4.6.0/helm-secrets.tar.gz
              mkdir -p /custom-tools/helm-plugins
              tar -zxf /tmp/helm-secrets.tar.gz -C /custom-tools/helm-plugins
              
              # FIX: Helm sometimes fails to pick the right command if platformCommand exists.
              # We overwrite plugin.yaml with a clean Linux-only version.
              cat <<EOF > /custom-tools/helm-plugins/helm-secrets/plugin.yaml
              name: "secrets"
              version: "4.6.0"
              usage: "Secrets encryption in Helm for Git storing"
              description: "This plugin provides secrets values encryption for Helm charts secure storing"
              useTunnel: false
              command: "\$HELM_PLUGIN_DIR/scripts/run.sh"
              EOF
          volumeMounts:
            - name: custom-tools
              mountPath: /custom-tools
      containers:
        - name: argocd-repo-server
          volumeMounts:
            - mountPath: /var/run/argocd
              name: var-files
            - mountPath: /home/argocd/cmp-server/plugins
              name: plugins-dir
        - name: helm-secrets
          image: quay.io/argoproj/argocd:v3.2.3
          command: ["/bin/sh", "-c"]
          args:
            - |
              export PATH=$PATH:/custom-tools
              export HELM_PLUGINS=/custom-tools/helm-plugins
              argocd-cmp-server --loglevel debug
          env:
            - name: SOPS_AGE_KEY_FILE
              value: /helm-secrets/keys.txt
            - name: HELM_PLUGINS
              value: /custom-tools/helm-plugins
            - name: SOPS_BINARY
              value: /custom-tools/sops
          volumeMounts:
            - mountPath: /var/run/argocd
              name: var-files
            - mountPath: /home/argocd/cmp-server/plugins
              name: plugins-dir
            - mountPath: /custom-tools
              name: custom-tools
            - mountPath: /home/argocd/cmp-server/config/plugin.yaml
              subPath: plugin.yaml
              name: cmp-plugin
            - mountPath: /helm-secrets/keys.txt
              subPath: keys.txt
              name: sops-age