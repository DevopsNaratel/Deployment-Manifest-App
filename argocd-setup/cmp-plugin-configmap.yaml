apiVersion: v1
kind: ConfigMap
metadata:
  name: cmp-plugin
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: helm-secrets
    spec:
      allowConcurrency: true
      discover:
        find:
          command: ["sh", "-c", "echo ok"]
      generate:
        command: ["/bin/sh", "-c"]
        args:
          - |
            export PATH=$PATH:/custom-tools
            export SOPS_AGE_KEY_FILE=/helm-secrets/keys.txt
            
            # 1. Get Values Files (Space separated string)
            VALS_LIST=${ARGOCD_ENV_HELM_VALUES:-$HELM_VALUES}
            
            # --- FALLBACK (No Values) ---
            if [ -z "$VALS_LIST" ]; then
              if [ -f "Chart.yaml" ]; then
                 helm template .
                 exit 0
              fi
              if ls *.yaml >/dev/null 2>&1; then
                cat *.yaml
              fi
              exit 0
            fi
            
            # --- BUILD HELM ARGS ---
            HELM_ARGS=""
            
            for file in $VALS_LIST; do
               # Handle relative paths from base-chart context
               
               if [ ! -f "$file" ]; then
                  echo "Warning: File $file not found, skipping." >&2
                  continue
               fi

               # Check if file is SOPS encrypted
               if grep -q "sops:" "$file"; then
                   echo "Decrypting $file..." >&2
                   # Create a unique temp file name
                   # We use basename to avoid directory issues in temp filenames
                   safe_name=$(basename "$file")
                   DEC_FILE="/tmp/${safe_name}.dec.yaml"
                   
                   /custom-tools/sops --decrypt --ignore-mac "$file" > "$DEC_FILE"
                   if [ $? -eq 0 ]; then
                      HELM_ARGS="$HELM_ARGS -f $DEC_FILE"
                   else
                      echo "Error decrypting $file" >&2
                      exit 1
                   fi
               else
                   echo "Using plaintext $file..." >&2
                   HELM_ARGS="$HELM_ARGS -f $file"
               fi
            done
            
            echo "Running: helm template . $HELM_ARGS" >&2
            helm template . $HELM_ARGS
      lockRepo: false
