apiVersion: v1
kind: ConfigMap
metadata:
  name: cmp-plugin
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: helm-secrets
    spec:
      allowConcurrency: true
      discover:
        find:
          # Force discovery to ALWAYS TRUE.
          # We handle the non-helm apps in the generate phase.
          command: ["sh", "-c", "echo ok"]
      generate:
        command: ["/bin/sh", "-c"]
        args:
          - |
            export PATH=$PATH:/custom-tools
            export SOPS_AGE_KEY_FILE=/helm-secrets/keys.txt
            
            VALS_FILE=${ARGOCD_ENV_HELM_VALUES:-$HELM_VALUES}
            
            # --- FALLBACK FOR ROOT-APP (No Values File) ---
            if [ -z "$VALS_FILE" ]; then
              echo "DEBUG: No HELM_VALUES set. Assuming Directory mode." >&2
              
              # If Chart.yaml exists, try helm template without values (unlikely for root-app but safe)
              if [ -f "Chart.yaml" ]; then
                 helm template .
                 exit 0
              fi
              
              # Otherwise, cat all yaml files (Directory App simulation)
              # Only cat if files exist to avoid error
              if ls *.yaml >/dev/null 2>&1; then
                # awk logic to ensure separators between files if needed, or just cat
                # Simple cat is usually enough for single file or well-formed yamls
                cat *.yaml
              else
                echo "DEBUG: No YAML files found." >&2
              fi
              exit 0
            fi
            # ----------------------------------------------
            
            # --- NORMAL FLOW FOR CHILD APPS ---
            echo "Decrypting $VALS_FILE using direct SOPS binary..." >&2
            
            /custom-tools/sops --decrypt --ignore-mac "$VALS_FILE" > values.dec.yaml
            
            if [ $? -ne 0 ]; then
               echo "ERROR: SOPS Decryption failed" >&2
               exit 1
            fi
            
            helm template . -f values.dec.yaml
      lockRepo: false
