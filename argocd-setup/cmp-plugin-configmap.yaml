apiVersion: v1
kind: ConfigMap
metadata:
  name: cmp-plugin
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: helm-secrets
    spec:
      allowConcurrency: true
      discover:
        find:
          command: ["sh", "-c", "echo 'ok'"]
      generate:
        command: ["/bin/sh", "-c"]
        args:
          - |
            export PATH=$PATH:/custom-tools
            export SOPS_AGE_KEY_FILE=/helm-secrets/keys.txt
            
            # Get the values file path
            VALS_FILE=${ARGOCD_ENV_HELM_VALUES:-$HELM_VALUES}
            
            if [ -z "$VALS_FILE" ]; then
              echo "ERROR: HELM_VALUES is not set!" >&2
              exit 1
            fi
            
            echo "Decrypting $VALS_FILE using direct SOPS binary..." >&2
            
            # DIRECT SOPS CALL
            # We bypass the helm-secrets wrapper to avoid argument parsing issues.
            # We use --ignore-mac to handle the MAC mismatch issue.
            /custom-tools/sops --decrypt --ignore-mac "$VALS_FILE" > values.dec.yaml
            
            EXIT_CODE=$?
            if [ $EXIT_CODE -ne 0 ]; then
               echo "ERROR: SOPS Decryption failed with code $EXIT_CODE" >&2
               exit 1
            fi
            
            # Run helm template with the decrypted file
            helm template . -f values.dec.yaml
      lockRepo: false