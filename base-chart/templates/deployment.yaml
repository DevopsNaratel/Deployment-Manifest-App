{{- if eq .Values.controllerType "Deployment" }}

apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-{{ include "base-chart.name" . }}
  namespace: {{ if eq .Values.app.env "testing" }}testing{{ else }}{{ .Values.app.id }}-{{ .Values.app.name | replace "-db" "" }}{{ end }}
  labels:
    {{- include "base-chart.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount | default 1 }}
  selector:
    matchLabels:
      app.kubernetes.io/id: {{ .Values.app.id | quote }}
  template:
    metadata:
      annotations:
        checksum/secrets: {{ toYaml .Values.secretData | sha256sum }}
      labels:
        {{- include "base-chart.labels" . | nindent 8 }}
    spec:
      # --- FIX: Menunggu Database Siap (Dinamis) ---
      initContainers:
        - name: wait-for-db
          image: busybox:1.28
          envFrom:
            - secretRef:
                name: secret-{{ include "base-chart.name" . }}
          # Hanya jalankan nc jika DB_HOST ada isinya
          command: ['sh', '-c', "if [ -n "$DB_HOST" ]; then until nc -zv $DB_HOST ${DB_PORT:-5432}; do echo waiting for database $DB_HOST; sleep 2; done; fi"]
      # ---------------------------------------------
      containers:
        - name: main
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          envFrom:
            - secretRef:
                name: secret-{{ include "base-chart.name" . }}

{{- end }}
